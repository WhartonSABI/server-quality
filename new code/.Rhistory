m <- length(p)
index <- order(p * alpha, decreasing = TRUE)
p_sorted <- p[index]
alpha_sorted <- alpha[index]
pt <- cumsum(p_sorted)
sigma_t <- cumsum(1 / alpha_sorted)
b_vals <- (1 - pt) / (1 - sigma_t)
b <- min(b_vals[b_vals > 0])  # Only positive b
f_sorted <- pmax(0, p_sorted - b / alpha_sorted)
f <- numeric(m)
f[index] <- f_sorted
return(f)
}
f_kelly <- kelly_allocation(p, alpha)
f_kelly # second and third are positive
f_kelly_posEV <- ifelse(p * alpha - 1 > 0, f_kelly, 0)
## simulation
set.seed(1)
simulate_strategy <- function(f_strategy, p, alpha, N = 1000, M = 100) {
bankrolls <- numeric(M)
for (j in 1:M) {
bankroll <- 1
for (i in 1:N) {
outcome <- sample(1:3, size = 1, prob = p)
payout <- f_strategy[outcome] * alpha[outcome]
loss <- sum(f_strategy)
bankroll <- bankroll * (1 - loss + payout)
}
bankrolls[j] <- bankroll
}
return(bankrolls)
}
bank_kelly <- simulate_strategy(f_kelly, p, alpha)
bank_kelly_posEV <- simulate_strategy(f_kelly_posEV, p, alpha)
df_plot <- data.frame(
FinalBankroll = c(bank_kelly, bank_kelly_posEV),
Strategy = rep(c("Full Kelly", "Kelly on +EV Only"), each = length(bank_kelly))
)
ggplot(df_plot, aes(x = Strategy, y = FinalBankroll, fill = Strategy)) +
geom_boxplot() +
labs(title = "Final Bankrolls After 1000 Bets (100 Simulations)",
y = "Final Bankroll", x = "") +
theme_minimal()
# Which yields more wealth on average? How much more?
mean_kelly <- mean(bank_kelly)
mean_kelly_posEV <- mean(bank_kelly_posEV)
mean_kelly > mean_kelly_posEV
setwd("C:/UPenn/tennis_wsabi/new code")
rm(list=ls())
# rm(list=ls())
# install.packages("welo")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
## wimbledon 2021
subset_2021_m <- as.data.table(read.csv("../data/wimbledon_subset_2021_m.csv"))
View(subset_2021_m)
subset_2021_f <- as.data.table(read.csv("../data/wimbledon_subset_2021_f.csv"))
names(subset_2021_m)
## EDA male
# graph distribution of serve speed (speed_mph) after splitting into first & second serves
ggplot(subset_2021_m, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
## EDA male
# graph distribution of serve speed (speed_mph) after splitting into first & second serves
# add line for mean of each histogram
ggplot(subset_2021_m, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
mean_speeds <- subset_2021_m %>%
group_by(ServeNumber) %>%
summarise(mean_speed = mean(Speed_MPH, na.rm = TRUE))
ggplot(subset_2021_m, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
mean_speeds_f <- subset_2021_f %>%
group_by(ServeNumber) %>%
summarise(mean_speed = mean(Speed_MPH, na.rm = TRUE))
ggplot(subset_2021_f, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (2021 Males)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
ggplot(subset_2021_f, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds_f, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (2021 Males)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
View(subset_2021_f)
rm(list=ls())
# rm(list=ls())
# install.packages("welo")
library(welo)
library(tidyverse)
library(data.table)
subset_2021_m <- as.data.table(read.csv("../data/wimbledon_subset_2021_m.csv"))
subset_2021_f <- as.data.table(read.csv("../data/wimbledon_subset_2021_f.csv"))
subset_2022_m <- as.data.table(read.csv("../data/wimbledon_subset_2022_m.csv"))
subset_2022_f <- as.data.table(read.csv("../data/wimbledon_subset_2022_f.csv"))
subset_2023_m <- as.data.table(read.csv("../data/wimbledon_subset_2023_m.csv"))
subset_2023_f <- as.data.table(read.csv("../data/wimbledon_subset_2023_f.csv"))
subset_2024_m <- as.data.table(read.csv("../data/wimbledon_subset_2024_m.csv"))
subset_2024_f <- as.data.table(read.csv("../data/wimbledon_subset_2024_f.csv"))
View(subset_2021_f)
# combine male data
subset_m <- rbindlist(list(
subset_2021_m,
subset_2022_m,
subset_2023_m,
subset_2024_m
))
write.csv(subset_m, "../data/wimbledon_subset_m.csv")
View(subset_m)
# combine male data
subset_f <- rbindlist(list(
subset_2021_f,
subset_2022_f,
subset_2023_f,
subset_2024_f
))
write.csv(subset_f, "../data/wimbledon_subset_f.csv")
View(subset_f)
rm(list=ls())
# rm(list=ls())
# install.packages("welo")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
mean_speeds <- subset_m %>%
group_by(ServeNumber) %>%
summarise(mean_speed = mean(Speed_MPH, na.rm = TRUE))
ggplot(subset_m, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (2021 Males)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
ggplot(subset_m, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (Males)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
# save graph
ggsave("../images/serve_speed_males.png")
mean_speeds_f <- subset_f %>%
group_by(ServeNumber) %>%
summarise(mean_speed = mean(Speed_MPH, na.rm = TRUE))
ggplot(subset_f, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds_f, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (2021 Males)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males") +
theme_minimal()
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_opint(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males") +
theme_minimal()
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_point(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males") +
theme_minimal()
## all serves (first and second)
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males") +
theme_minimal()
View(subset_f)
## split between 1st and 2nd serves
# first serves
first_serves <- subset_m %>%
filter(ServeNumber == 1)
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_point() +
labs(title = "Serve Speed vs. Win Outcome for First Serves") +
theme_minimal()
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for First Serves") +
theme_minimal()
second_serves <- subset_m %>%
filter(ServeNumber == 2)
ggplot(second_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_point() +
labs(title = "Serve Speed vs. Win Outcome for Second Serves") +
theme_minimal()
ggplot(second_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for Second Serves") +
theme_minimal()
## filter out RallyCount == 1
subset_m_test <- subset_m %>%
filter(RallyCount == 1)
View(subset_m_test)
## all serves (first and second)
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males)") +
theme_minimal()
## all serves (first and second)
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males)") +
theme_minimal()
## all serves (first and second)
ggplot(subset_m, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome (Males, All Serves)") +
theme_minimal()
## split between 1st and 2nd serves
# first serves
first_serves <- subset_m %>%
filter(ServeNumber == 1)
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_point() +
labs(title = "Serve Speed vs. Win Outcome for First Serves") +
theme_minimal()
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for First Serves") +
theme_minimal()
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for First Serves (Males, First Serves") +
theme_minimal()
ggplot(first_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for First Serves (Males, First Serves)") +
theme_minimal()
second_serves <- subset_m %>%
filter(ServeNumber == 2)
ggplot(second_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_point() +
labs(title = "Serve Speed vs. Win Outcome for Second Serves (Males, Second Serves)") +
theme_minimal()
ggplot(second_serves, aes(x = Speed_MPH, y = serving_player_won)) +
geom_density2d_filled(alpha = 0.8) +
labs(title = "Serve Speed vs. Win Outcome for Second Serves (Males, Second Serves)") +
theme_minimal()
rm(list=ls())
# rm(list=ls())
# install.packages("welo")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
## male
# player_names
player_names <- unique(c(subset_m$player1_name, subset_m$player2_name))
# Create a design matrix with columns: one column per player
X <- matrix(0, nrow = nrow(subset_m), ncol = length(player_names))
colnames(X) <- c("B0", paste0("B", player_names))
colnames(X) <- c(paste0("B", player_names))
View(X)
colnames(X) <- c(paste0("B_", player_names))
View(X)
View(subset_m)
## loop through each row in subset_m (which corresponds with each row in X)
# put 1 in the column corresponding to player1 and -1 in the column corresponding to player2
for (i in 1:nrow(subset_m)) {
row <- subset_m[i, ]
player1 <- row$player1_name
player2 <- row$player2_name
winner <- row$PointWinner
# Set +1 for player1, -1 for player2
X[i, paste0("B_", player1)] <- 1
X[i, paste0("B_", player2)] <- -1
# Store outcome (1 if player1 won, 0 if player2 won)
subset_m$outcome[i] <- ifelse(outcome == player1, 1, 0)
}
## loop through each row in subset_m (which corresponds with each row in X)
# put 1 in the column corresponding to player1 and -1 in the column corresponding to player2
for (i in 1:nrow(subset_m)) {
row <- subset_m[i, ]
player1 <- row$player1_name
player2 <- row$player2_name
winner <- row$PointWinner
# Set +1 for player1, -1 for player2
X[i, paste0("B_", player1)] <- 1
X[i, paste0("B_", player2)] <- -1
# Store outcome (1 if player1 won, 0 if player2 won)
subset_m$winner[i] <- ifelse(winner == player1, 1, 0)
}
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
names(subset_m)
## male
# player_names
player_names <- unique(c(subset_m$player1_name, subset_m$player2_name))
# Create a design matrix with columns: one column per player
X <- matrix(0, nrow = nrow(subset_m), ncol = length(player_names))
colnames(X) <- c(paste0("B_", player_names))
## loop through each row in subset_m (which corresponds with each row in X)
# put 1 in the column corresponding to player1 and -1 in the column corresponding to player2
for (i in 1:nrow(subset_m)) {
row <- subset_m[i, ]
player1 <- row$player1_name
player2 <- row$player2_name
winner <- row$PointWinner
# Set +1 for player1, -1 for player2
X[i, paste0("B_", player1)] <- 1
X[i, paste0("B_", player2)] <- -1
# Store outcome (1 if player1 won, 0 if player2 won)
subset_m$winner[i] <- ifelse(winner == player1, 1, 0)
}
names(subset_m)
## male
subset_m_test <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(player1_avg_welo - player2_avg_welo)),
1 / (1 + exp(player2_avg_welo - player1_avg_welo))))
View(subset_m_test)
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
## male
subset_m_test <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(player1_avg_welo - player2_avg_welo)),
1 / (1 + exp(player2_avg_welo - player1_avg_welo))))
View(subset_m_test)
names(subset_m_test)
mean_speeds_f <- subset_f %>%
group_by(ServeNumber) %>%
summarise(mean_speed = mean(Speed_MPH, na.rm = TRUE))
ggplot(subset_f, aes(x = Speed_MPH)) +
geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
facet_wrap(~ ServeNumber) +
geom_vline(data = mean_speeds_f, aes(xintercept = mean_speed),
color = "red", linetype = "dashed", size = 1) +
labs(title = "Distribution of Serve Speed (mph) by Serve Number (2021 Female)",
x = "Serve Speed (mph)",
y = "Count") +
theme_minimal()
names(subset_m)
# Convert ELO to logistic (Bradley-Terry scale)
subset_m[, welo_p1_bt := 0.0057565 * player1_avg_welo]
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
# Convert ELO to logistic (Bradley-Terry scale)
subset_m[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_m[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## male
subset_m_test <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
View(subset_m_test)
# Convert ELO to logistic (Bradley-Terry scale)
subset_f[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_f[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## male
subset_m <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
## female
subset_f <- subset_f %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
View(subset_m)
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
# Convert ELO to logistic (Bradley-Terry scale)
subset_m[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_m[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## male
subset_m <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
names(subset_m)
# rename column in subset_m
subset_m <- subset_m %>%
rename('... <- NULL' = 'p_server_beats_returner')
# rename column in subset_m
subset_m <- subset_m %>%
rename('... <- NULL' = p_server_beats_returner)
names(subset_m)
# rename column in subset_m
setnames(subset_m, old = c("... <- NULL"),
new = c("p_server_beats_returner"))
names(subset_m)
View(subset_m)
# Convert ELO to logistic (Bradley-Terry scale)
subset_f[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_f[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## female
subset_f <- subset_f %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
# rename column in subset_f
setnames(subset_f, old = c("... <- NULL"),
new = c("p_server_beats_returner"))
View(subset_f)
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
# Convert ELO to logistic (Bradley-Terry scale)
subset_f[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_f[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## female
subset_f <- subset_f %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p1_bt - welo_p2_bt)),
1 / (1 + exp(welo_p2_bt - welo_p1_bt))))
View(subset_f)
View(subset_m)
## male
subset_m <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p2_bt - welo_p1_bt)),
1 / (1 + exp(welo_p1_bt - welo_p2_bt))))
View(subset_m)
## wimbledon 2021
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
# Convert ELO to logistic (Bradley-Terry scale)
subset_m[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_m[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## male
subset_m <- subset_m %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p2_bt - welo_p1_bt)),
1 / (1 + exp(welo_p1_bt - welo_p2_bt))))
View(subset_m)
# rename column in subset_m
setnames(subset_m, old = c("... <- NULL"),
new = c("p_server_beats_returner"))
names(subset_m)
write.csv(subset_m, "../data/wimbledon_subset_m.csv", row.names = FALSE)
# Convert ELO to logistic (Bradley-Terry scale)
subset_f[, welo_p1_bt := 0.0057565 * player1_avg_welo]
subset_f[, welo_p2_bt := 0.0057565 * player2_avg_welo]
## female
subset_f <- subset_f %>%
mutate(p_server_beats_returner <- ifelse(PointServer == 1,
1 / (1 + exp(welo_p2_bt - welo_p1_bt)),
1 / (1 + exp(welo_p1_bt - welo_p2_bt))))
View(subset_f)
# rename column in subset_f
setnames(subset_f, old = c("... <- NULL"),
new = c("p_server_beats_returner"))
names(subset_m)
write.csv(subset_f, "../data/wimbledon_subset_f.csv", row.names = FALSE)
View(subset_m)
## logistic regression for serving_player_won vs. p_server_beats_returner
logit_model_m <- glm(serving_player_won ~ p_server_beats_returner,
data = subset_m, family = "binomial")
summary(logit_model_m)
logit_model_f <- glm(serving_player_won ~ p_server_beats_returner,
data = subset_f, family = "binomial")
summary(logit_model_f)
names(subset_m)
logit_model_2_m <- glm(serving_player_won ~ p_server_beats_returner + ElapsedSeconds,
data = subset_m, family = "binomial")
summary(logit_model_2_m)
logit_model_2_f <- glm(serving_player_won ~ p_server_beats_returner + ElapsedSeconds,
data = subset_f, family = "binomial")
summary(logit_model_2_f)
