H_n <- function(t, j, k) {
return(2^(j/2) * H(2^j * t - k))
}
# Plotting function using ggplot2
plot_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet to the data
mother_wavelet <- data.frame(t = t_vals, H_t = sapply(t_vals, H), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the wavelets H_n(t) to the data
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, H_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, H_t = wavelet_vals, wavelet = paste("H_", n, "(t)", sep = ""))
data_list[[n + 1]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = H_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max))) +  # Set custom colors
labs(title = paste("Mother Wavelet and H_n(t) for n = 1 to", n_max),
x = "t", y = "H(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(7)
# Define the triangle function Delta(t)
Delta <- function(t) {
if (t >= 0 && t < 0.5) {
return(2 * t)
} else if (t >= 0.5 && t <= 1) {
return(2 * (1 - t))
} else {
return(0)
}
}
# Define the sequence of functions Delta_n(t)
Delta_n <- function(t, j, k) {
ifelse(t==0, return(t), return(Delta(2^j * t - k)))
}
# Plotting function using ggplot2
plot_triangle_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet (Delta(t)) to the data--i think mother wavelet is same as delta_1
mother_wavelet <- data.frame(t = t_vals, Delta_t = sapply(t_vals, Delta), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the functions Delta_n(t) for n = 1 to n_max
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, Delta_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, Delta_t = wavelet_vals, wavelet = paste("Delta_", n, "(t)", sep = ""))
data_list[[n + 2]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = Delta_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max + 1))) +  # Set custom colors (blue for mother wavelet)
labs(title = paste("Delta_n(t) and Mother Wavelet for n = 0 to", n_max),
x = "t", y = "Delta(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot Delta_n(t) for n from 0 to 7 with different colors and including the mother wavelet
plot_triangle_wavelets(7)
# Define lambda_n calculation
lambda_n <- function(n) {
if (n == 0) {
return(1)
} else {
j <- floor(log2(n))  # This corresponds to the j value for n = 2^j + k
return(1/2 * 2^(-j/2))
}
}
# Define X_t as the sum of terms for each t
X_t <- function(t, n_max) {
Xt_sum <- 0
for (n in 0:n_max) {
j <- floor(log2(n))
k <- n - 2^j
lambda_n_value <- lambda_n(n)
Z_n <- rnorm(1)  # Generating standard normal random variable
Xt_sum <- Xt_sum + lambda_n_value * Z_n * Delta_n(t, j, k)
}
return(Xt_sum)
}
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 16)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function using ggplot2
plot_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet to the data
mother_wavelet <- data.frame(t = t_vals, H_t = sapply(t_vals, H), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the wavelets H_n(t) to the data
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, H_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, H_t = wavelet_vals, wavelet = paste("H_", n, "(t)", sep = ""))
data_list[[n + 1]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = H_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max))) +  # Set custom colors
labs(title = paste("Mother Wavelet and H_n(t) for n = 1 to", n_max),
x = "t", y = "H(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(3)
p_be <- 11 / 21
z <- qnorm(0.975)
p_values <- seq(p_BE + 1e-4, 1, length.out = 100)
p_values <- seq(p_be + 1e-4, 1, length.out = 100)
n_required <- numeric(length(p_values))
for (i in 1:length(p_values)) {
p <- p_values[i]
num <- z * sqrt(p * (1 - p))
denom <- p - p_BE
n_required[i] <- ceiling((num / denom)^2)
}
for (i in 1:length(p_values)) {
p <- p_values[i]
num <- z * sqrt(p * (1 - p))
denom <- p - p_be
n_required[i] <- ceiling((num / denom)^2)
}
# dataframe for lpotting
plot_data <- data.frame(
p = p_values,
n = n_required
)
ggplot(plot_data, aes(x = p, y = n)) +
geom_line(color = "blue", size = 1) +
geom_vline(xintercept = p_be, linetype = "dashed", color = "red") +
labs(title = "Number of Bets Needed for 95% Confidence of Profitability",
x = "True Success Rate (p)",
y = "Minimum Bets Needed (n)") +
theme_minimal()
# install.packages(c("ggplot2", "tidyverse"))
library(ggplot2)
library(tidyverse)
library(broom)
ggplot(plot_data, aes(x = p, y = n)) +
geom_line(color = "blue", size = 1) +
geom_vline(xintercept = p_be, linetype = "dashed", color = "red") +
labs(title = "Number of Bets Needed for 95% Confidence of Profitability",
x = "True Success Rate (p)",
y = "Minimum Bets Needed (n)") +
theme_minimal()
n_required
View(plot_data)
# --- Load libraries ---
rm(list = ls())
library(tidyverse)
library(data.table)
library(lme4)
# --- Load data ---
# change wimbledon or usopen as desired
subset_m <- fread("out_data/scaled/usopen_subset_m_training.csv")
setwd("C:/UPenn/tennis_wsabi/new code")
# --- Load data ---
# change wimbledon or usopen as desired
subset_m <- fread("out_data/scaled/usopen_subset_m_training.csv")
subset_f <- fread("out_data/scaled/usopen_subset_f_training.csv")
names(subset_m)
View(subset_m)
unique(subset_m$year)
unique(subset_f$year)
# --- Load libraries ---
rm(list = ls())
library(tidyverse)
library(data.table)
library(lme4)
# --- Load data ---
subset_m <- fread("out_data/scaled/usopen_subset_m_training.csv")
subset_f <- fread("out_data/scaled/usopen_subset_f_training.csv")
# --- Add server_name column ---
subset_m <- subset_m %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
subset_f <- subset_f %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
# --- Split into serve groups ---
groups <- list(
m_first  = subset_m[ServeNumber == 1 & Speed_MPH > 0],
m_second = subset_m[ServeNumber == 2 & Speed_MPH > 0],
f_first  = subset_f[ServeNumber == 1 & Speed_MPH > 0],
f_second = subset_f[ServeNumber == 2 & Speed_MPH > 0]
)
# --- Prepare storage ---
all_effects <- list()
top_bottom <- list()
extreme_sd <- list()
# --- Loop over serve groups and years ---
for (group_name in names(groups)) {
df_group <- groups[[group_name]]
years <- unique(df_group$year)
for (yr in years) {
df_year <- df_group %>% filter(year == yr)
model_id <- paste0(group_name, "_", yr)
# Fit model
model <- glmer(serving_player_won ~ p_server_beats_returner_z + Speed_MPH_z +
importance_z + df_pct_server_z + ElapsedSeconds_fixed_z +
factor(ServeWidth) + factor(ServeDepth) + (1 | server_name),
data = df_year, family = binomial)
# Extract random intercepts
ranef_df <- ranef(model)$server_name %>%
rownames_to_column("server_name") %>%
rename(random_intercept = `(Intercept)`) %>%
mutate(model = model_id, year = yr, group = group_name)
all_effects[[model_id]] <- ranef_df
# Top 10 / Bottom 10
top10 <- ranef_df %>%
arrange(desc(random_intercept)) %>%
slice(1:10) %>%
mutate(rank_label = "Top10")
bottom10 <- ranef_df %>%
arrange(random_intercept) %>%
slice(1:10) %>%
mutate(rank_label = "Bottom10")
top_bottom[[model_id]] <- bind_rows(top10, bottom10)
# ±2 SD performers
mu <- mean(ranef_df$random_intercept)
sd_val <- sd(ranef_df$random_intercept)
extreme_df <- ranef_df %>%
mutate(label = case_when(
random_intercept >= mu + 2 * sd_val ~ "Above_2SD",
random_intercept <= mu - 2 * sd_val ~ "Below_2SD",
TRUE ~ NA_character_
)) %>%
filter(!is.na(label))
extreme_sd[[model_id]] <- extreme_df
}
}
# --- Combine and save results ---
all_effects_df <- bind_rows(all_effects)
top_bottom_df <- bind_rows(top_bottom)
extreme_sd_df <- bind_rows(extreme_sd)
View(all_effects_df)
View(bottom10)
View(top_bottom_df)
View(extreme_sd_df)
# View or save
fwrite(all_effects_df, "new model results (with df data)/player effects/usopen_random_intercepts_by_year.csv")
fwrite(top_bottom_df, "new model results (with df data)/player effects/usopen_top_bottom_by_year.csv")
fwrite(extreme_sd_df, "new model results (with df data)/player effects/usopen_extreme_2sd_by_year.csv")
View(extreme_sd_df)
# --- Load libraries ---
rm(list = ls())
library(tidyverse)
library(data.table)
library(lme4)
library(ggplot2)
# --- Load data ---
subset_m <- fread("out_data/scaled/usopen_subset_m_training.csv")
subset_f <- fread("out_data/scaled/usopen_subset_f_training.csv")
# --- Add server_name column ---
subset_m <- subset_m %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
subset_f <- subset_f %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
# --- Split into serve groups ---
groups <- list(
m_first  = subset_m[ServeNumber == 1 & Speed_MPH > 0],
m_second = subset_m[ServeNumber == 2 & Speed_MPH > 0],
f_first  = subset_f[ServeNumber == 1 & Speed_MPH > 0],
f_second = subset_f[ServeNumber == 2 & Speed_MPH > 0]
)
# --- Prepare storage ---
all_effects <- list()
top_bottom <- list()
extreme_sd <- list()
# --- Create output directory for plots ---
output_dir <- "../images/player effects/by_year"
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
# --- Loop over serve groups and years ---
for (group_name in names(groups)) {
df_group <- groups[[group_name]]
years <- unique(df_group$year)
for (yr in years) {
df_year <- df_group %>% filter(year == yr)
model_id <- paste0(group_name, "_", yr)
# Fit model
model <- glmer(serving_player_won ~ p_server_beats_returner_z + Speed_MPH_z +
importance_z + df_pct_server_z + ElapsedSeconds_fixed_z +
factor(ServeWidth) + factor(ServeDepth) + (1 | server_name),
data = df_year, family = binomial)
# Extract random intercepts
ranef_df <- ranef(model)$server_name %>%
rownames_to_column("server_name") %>%
rename(random_intercept = `(Intercept)`) %>%
mutate(model = model_id, year = yr, group = group_name)
all_effects[[model_id]] <- ranef_df
# --- Top / Bottom 10 ---
top10 <- ranef_df %>%
arrange(desc(random_intercept)) %>%
slice(1:10) %>%
mutate(rank_label = "Top10")
bottom10 <- ranef_df %>%
arrange(random_intercept) %>%
slice(1:10) %>%
mutate(rank_label = "Bottom10")
top_bottom[[model_id]] <- bind_rows(top10, bottom10)
# --- ±2 SD extremes ---
mu <- mean(ranef_df$random_intercept)
sd_val <- sd(ranef_df$random_intercept)
extreme_df <- ranef_df %>%
mutate(label = case_when(
random_intercept >= mu + 2 * sd_val ~ "Above_2SD",
random_intercept <= mu - 2 * sd_val ~ "Below_2SD",
TRUE ~ NA_character_
)) %>%
filter(!is.na(label))
extreme_sd[[model_id]] <- extreme_df
# --- Plot ---
plot_df <- ranef_df %>%
mutate(label = case_when(
server_name %in% top10$server_name ~ "Top10",
server_name %in% bottom10$server_name ~ "Bottom10",
TRUE ~ "Average"
))
p <- ggplot(plot_df, aes(x = reorder(server_name, random_intercept),
y = random_intercept, fill = label)) +
geom_col(show.legend = FALSE) +
coord_flip() +
labs(
title = paste("Random Intercepts —", group_name, yr),
x = "Server", y = "Random Intercept"
) +
scale_fill_manual(values = c("Top10" = "darkgreen", "Bottom10" = "darkred", "Average" = "grey70")) +
theme_minimal()
ggsave(filename = file.path(output_dir, paste0(model_id, "_ranef.png")),
plot = p, width = 8, height = 10, units = "in", bg = "white")
}
}
# --- Combine and save all results ---
all_effects_df <- bind_rows(all_effects)
top_bottom_df <- bind_rows(top_bottom)
extreme_sd_df <- bind_rows(extreme_sd)
# --- Load libraries ---
rm(list = ls())
library(tidyverse)
library(data.table)
library(lme4)
library(ggplot2)
# --- Load data ---
subset_m <- fread("out_data/scaled/wimbledon_subset_m_training.csv")
subset_f <- fread("out_data/scaled/wimbledon_subset_f_training.csv")
# --- Add server_name column ---
subset_m <- subset_m %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
subset_f <- subset_f %>%
mutate(server_name = if_else(PointServer == 1, player1, player2))
# --- Split into serve groups ---
groups <- list(
m_first  = subset_m[ServeNumber == 1 & Speed_MPH > 0],
m_second = subset_m[ServeNumber == 2 & Speed_MPH > 0],
f_first  = subset_f[ServeNumber == 1 & Speed_MPH > 0],
f_second = subset_f[ServeNumber == 2 & Speed_MPH > 0]
)
# --- Prepare storage ---
all_effects <- list()
top_bottom <- list()
extreme_sd <- list()
# --- Create output directory for plots ---
output_dir <- "../images/player effects/by_year"
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
# --- Loop over serve groups and years ---
for (group_name in names(groups)) {
df_group <- groups[[group_name]]
years <- unique(df_group$year)
for (yr in years) {
df_year <- df_group %>% filter(year == yr)
model_id <- paste0(group_name, "_", yr)
# Fit model
model <- glmer(serving_player_won ~ p_server_beats_returner_z + Speed_MPH_z +
importance_z + df_pct_server_z + ElapsedSeconds_fixed_z +
factor(ServeWidth) + factor(ServeDepth) + (1 | server_name),
data = df_year, family = binomial)
# Extract random intercepts
ranef_df <- ranef(model)$server_name %>%
rownames_to_column("server_name") %>%
rename(random_intercept = `(Intercept)`) %>%
mutate(model = model_id, year = yr, group = group_name)
all_effects[[model_id]] <- ranef_df
# --- Top / Bottom 10 ---
top10 <- ranef_df %>%
arrange(desc(random_intercept)) %>%
slice(1:10) %>%
mutate(rank_label = "Top10")
bottom10 <- ranef_df %>%
arrange(random_intercept) %>%
slice(1:10) %>%
mutate(rank_label = "Bottom10")
top_bottom[[model_id]] <- bind_rows(top10, bottom10)
# --- ±2 SD extremes ---
mu <- mean(ranef_df$random_intercept)
sd_val <- sd(ranef_df$random_intercept)
extreme_df <- ranef_df %>%
mutate(label = case_when(
random_intercept >= mu + 2 * sd_val ~ "Above_2SD",
random_intercept <= mu - 2 * sd_val ~ "Below_2SD",
TRUE ~ NA_character_
)) %>%
filter(!is.na(label))
extreme_sd[[model_id]] <- extreme_df
# --- Plot ---
plot_df <- ranef_df %>%
mutate(label = case_when(
server_name %in% top10$server_name ~ "Top10",
server_name %in% bottom10$server_name ~ "Bottom10",
TRUE ~ "Average"
))
p <- ggplot(plot_df, aes(x = reorder(server_name, random_intercept),
y = random_intercept, fill = label)) +
geom_col(show.legend = FALSE) +
coord_flip() +
labs(
title = paste("Random Intercepts —", group_name, yr),
x = "Server", y = "Random Intercept"
) +
scale_fill_manual(values = c("Top10" = "darkgreen", "Bottom10" = "darkred", "Average" = "grey70")) +
theme_minimal()
ggsave(filename = file.path(output_dir, paste0(model_id, "_ranef.png")),
plot = p, width = 8, height = 10, units = "in", bg = "white")
}
}
# --- Combine and save all results ---
all_effects_df <- bind_rows(all_effects)
top_bottom_df <- bind_rows(top_bottom)
extreme_sd_df <- bind_rows(extreme_sd)
# Save to CSV
fwrite(all_effects_df, "new model results (with df data)/player effects/wimbledon_random_intercepts_by_year.csv")
fwrite(top_bottom_df, "new model results (with df data)/player effects/wimbledon_top_bottom_by_year.csv")
fwrite(extreme_sd_df, "new model results (with df data)/player effects/wimbledon_extreme_2sd_by_year.csv")
View(top_bottom_df)
View(extreme_sd_df)
